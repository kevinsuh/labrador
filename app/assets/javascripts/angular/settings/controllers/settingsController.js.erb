(function() {
	
	/**
	 * this controller is specific for user viewing his queued / purchased cards
	 */
	var app = angular.module('card-queue').controller("SettingsController", function($rootScope, $location, $window, $scope, $state, $timeout, user) {
			
		headerTitle = angular.element(document.querySelector("#currentTitle"));
		headerTitle.text("Settings");

		// infinite scroll once this angular controller is loaded
		ScaleContentToDevice();

		$scope.currentTitle = "Settings";

		$scope.currentUser = user.currentUser;

		// create backups in case user cancels
		$scope.currentUserTemplate = angular.copy($scope.currentUser);

		// test whether you are currently at this state or not
		$scope.$on('$stateChangeSuccess',
		  function(event, toState) {
		    $scope.currentState = toState.name;
		    makeStateActive($scope.currentState);
		  });

		/**
		 * 		HANDLE NAVIGATION OF TABS
		 */
		$scope.settings = {
			displayState: "Home"
		}

		// new address
		$scope.newUserAddress = {
			address: {
				newAddress: true,
				is_primary: true
			}
		};
		$scope.newUserAddressTemplate = angular.copy($scope.newUserAddress.address);

		$scope.showPersonalInfoTab = function() {
			$scope.newUserAddress.address = angular.copy($scope.newUserAddressTemplate);
			$scope.settings.displayState = "Personal Info Form";
		}

		$scope.showHomeTab = function() {
			$scope.settings.displayState = "Home";	
		}

		/**
		 * 		SAVE / CANCEL FUNCTIONALITY ON PERSONAL INFO FORM
		 */
		$scope.savePersonalInfo = function() {

			currentUser = $scope.currentUser;
			newAddress  = $scope.newUserAddress.address;

			// add if it is a "new address" and has the right criteria
			if (newAddress.newAddress && newAddress.street && newAddress.city && newAddress.state && newAddress.zipcode) {
				currentUser.addresses.push(newAddress);
			}

			user.updateUser(currentUser)
			.success(function(data) {
				console.log("success in updating user");
				console.log(data);
				currentUser = data.user;
				$scope.currentUser = currentUser;
				$scope.settings.displayState = "Home";
			})
			.error(function(data) {
				console.log("error in update user settings");
				console.log(data);
			})
		}

		$scope.cancelPersonalInfo = function() {

			// reset back to template
			$scope.currentUser = angular.copy($scope.currentUserTemplate);
			$scope.settings.displayState = "Home";
		}

		/**
		 * 		SETTINGS FOOTER
		 */
		$scope.startQueueCardState = function() {
			// automatically just go to my people if in this view
			$state.go("main.app.my_people.home", {queueCardState: true, selectPersonToSendState: true});
		 }

	});

})();
