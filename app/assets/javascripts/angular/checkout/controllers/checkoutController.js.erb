(function() {
	
	/**
	 * this is the controller used to handle checkout of the cards you queued
	 */
	var app = angular.module('card-queue').controller("CheckoutController", function($rootScope, $location, $window, $scope, $state, $timeout, usSpinnerService, user, cards) {
			
		$scope.user           = user.currentUser;

		console.log($scope.user);

		$scope.stripe_account = user.stripe_account
		$scope.cards          = cards;
		$scope.queuedCards    = cards.queuedCards;

		$scope.viewCreditCardList = false;

		$scope.finalOptions = {
			address: $scope.user.primary_address
		};

		$scope.visibleOptions = {
			addressInfos: [$scope.user.primary_address.id],
			addressForms: [],
			creditCards: []
		}

		headerTitle = angular.element(document.querySelector("#currentTitle"));
		headerTitle.text("Checkout");
		
		$scope.viewAddressList     = false;
		$scope.viewEditAddressForm = false;
		$scope.viewSelectedAddress = true;

		// view address list
		$scope.displayAddressList = function() {
			$scope.viewAddressList     = true;
			$scope.viewEditAddressForm = false;
			$scope.viewSelectedAddress = false;
		}

		// make this your final shipping address
		$scope.chooseAddress = function(address) {
			$scope.finalOptions.address = address;
			$scope.viewAddressList      = false;
			$scope.viewEditAddressForm  = false;
			$scope.viewSelectedAddress  = true;
		}

		// edit single address
		$scope.editAddress = function(address) {

			// for cancel / save purposes
			$scope.editingAddress = angular.copy(address);

			$scope.viewAddressList     = false;
			$scope.viewEditAddressForm = true;
			$scope.viewSelectedAddress = false;

		}

		// save the editing single address
		$scope.updateAddress = function() {

			editedAddress = $scope.editingAddress;

			// should call a function to save address
			user.updateAddress(editedAddress)
      .success(function(data) {
      	// nothing to do on success
      })
      .error(function(data) {
        console.log("error in user saveAddress function");
        console.log(data);
      });

      addresses = $scope.user.addresses;
			for (var i = 0; i < addresses.length; i++) {
				if (addresses[i].id == editedAddress.id) {
					$scope.user.addresses[i] = editedAddress;
				}
			}

			// remove the addressID from visible address forms
			$scope.viewAddressList     = true;
			$scope.viewEditAddressForm = false;
			$scope.viewSelectedAddress = false;
			
		}

		// cancel the editing single address
		// for now, this means just return to address list view
		$scope.cancelSave = function() {

			// remove the addressID from visible address forms
			$scope.viewAddressList     = true;
			$scope.viewEditAddressForm = false;
			$scope.viewSelectedAddress = false;
			
		}

		// test whether you are currently at this state or not
		$scope.$on('$stateChangeSuccess',
		  function(event, toState) {
		    $scope.currentState = toState.name;
		    makeStateActive($scope.currentState);
	    });

		$scope.isInArray = function(value, array) {
    	return array.indexOf(value) > -1;
    }	

	});

})();
