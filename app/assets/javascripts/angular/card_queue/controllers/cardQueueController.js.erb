(function() {
	
	/**
	 * this controller is specific to queuing up the cards through an awesome multi-step form, then saving the data and queueing up another card
	 */
	var app = angular.module('card-queue').controller("CardQueueController", function($rootScope, $scope, $state, cards) {
			
			$scope.test = cards.test;
			$scope.newCard = cards.newCard;

			$scope.testImages = {
				one: '<%= asset_path("test_birthday1.jpg") %>',
				two: '<%= asset_path("test_birthday2.jpg") %>',
				three: '<%= asset_path("test_birthday3.jpg") %>'
			};

			/**
			 * submit the final card queue form that contains the information on newCard
			 * this will submit the form and upon success, add it to the queuedCards array of cards. on failure, it will let the user know what the issue is
			 */
	    $scope.submitCardQueueForm = function() {
	    	// first step is to create a date based on the values
				var day   = $scope.date.day;
				var month = $scope.date.month;
				var year  = "20" + $scope.date.year;
				var date  = new Date(year, month, day);

				$scope.newCard.recipientArrivalDate = date;
				var queuedCard = $scope.newCard;

	    	cards.queueCard()
	    	.success(function(data) {

					var order   = data.order;
					var isValid = order.is_valid;
	    		
					console.log(queuedCard);

		    	if (isValid) {

		    	} else {
		    		alert("Something went wrong. Is your form completely filled out?");
		    	}
				})
				.error(function(data) {
					console.log("error in submitCardQueueForm");
					console.log(data);
				});
	    };

			// new angular nl method
			$scope.occasions = cards.occasions;

			$scope.relationships = {
				Mother: 1,
				Father: 2,
				Sister: 3,
				Brother: 4,
				"Significant other (male)": 5,
				"Significant other (female)": 6,
				"Friend (male)": 7,
				"Friend (female)": 8,
				Grandmother: 9,
				Grandfather: 10,
				Mentor: 11
			};

			$scope.months = {
				January: 0,
				February: 1,
				March: 2,
				April: 3,
				May: 4,
				June: 5,
				July: 6,
				August: 7,
				September: 8,
				October: 9,
				November: 10,
				December: 11
			};

			$scope.cardFlavors = {
				"funny": 1,
				"witty": 2,
				"charming": 3,
				"cute": 4,
				"genuine": 5,
				"crazy": 6
			}

			// collect month, then make it into a datetime obj
			$scope.date = {
				month: "",
				day: "",
				year: ""
			}

			// don't allow more than 3 card flavors!
			$scope.$watch('newCard.cardFlavors.length', function(newValue, oldValue){
          if (newValue > 3) {
          	$scope.newCard.cardFlavors.shift();
          }
        }
	    );

	    $scope.$on('$stateChangeSuccess',
			  function(event, toState) {
			    $scope.currentState = toState.name;
			  }
			)
			
	});

})();

